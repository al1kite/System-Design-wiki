## CAP 이론

CAP 란 Consistency, Availability, Partition Tolerance
이 세 가지의 관계를 표현하는 이론이라고 볼 수 있다.

#### Consistency
CAP 이론에서 Consistency 란 일관성을 뜻하고 
스토리지와 관련된 영역에서 사태 일관성을 의미하는데 
예를 들어 어떤 키 A 에 대해서 값을 검색해보려고 하는데
검색자 철수와 영희가 동시에 검색했을 때 다른 검색 결과를 받아 보게 된다면
이 상태는 일관된 상태라고 볼 수 없다.

#### Availability
시스템이 의도대로 잘 동작하는 상태를 의미한다.
가용성이 높다는 건 `서비스가 어떤 상황에서도 의도대로 잘 동작하게 설계되었다` 라는 걸 의미

#### Partition Tolerance
분단 내성이라는 뜻인데, 분단된 상태에서도 컴포넌트가 잘 동작할 수 있는 능력을 의미.
예를 들어서 서비스 A가 서비스 B를 의존하며 네트워크를 통해 어떤 값을 요청해 와야 한다고 가정해보자.
이 상황에서 두 컴포넌트 네트워크가 분단되어 통신이 되지 않는 상황을 분단 상태라고 표현하는데,
특히 방금 든 예시는 네트워크 파티션이라고 불리는 상태이다.
이런 상태에서도 서비스 A가 어떻게든 동작을 수행할 수 있으면
서비스 A는 분단 내성이 있는 서비스라고 볼 수 있다.


CAP 이론은 3가지 속성 중 최대 2가지만 갖출 수 있다는 것을 의미하는 이론이다.
다시 말해, 어떤 서비스를 설계하다 보면 분단 내성이 있으면서 가용성 있는 서비스를 만들 수도 있고
또는 분단 내성이 있으면서 일관성이 있는 서비스를 만들 수는 있지만
분단 내성, 가용성, 일관성을 모두 갖춘 서비스는 불가능하다는 의미.

특히 이 이론이 분산 시스템에서 기본 전제로 깔려 있는 논리.
사실 이론이라 말하기 애매할 정도로 당연한 논리이기 때문에 
사람들은 쓸 모 없는 이론이라 표현하기도..

분산 시스템에서 분단 내성은 필수이다.
분산 시스템은 네트워크를 통해 컴포넌트 간 연결을 유지하는데
네트워크 파티션은 언제든 발생할 수 있다고 가정해야 하기 때문.
분단 내성을 고려하지 않은 분단 시스템은 없다.

그렇다면 분단이 발생해도 시스템이 동작해야 하는데
만약 일관성을 유지하려면 분단된 컴포넌트가 다시 돌아올 때까지 어떤 상태를 변경해서는 안 된다.
따라서 가용성을 보장 받지 못하는 상태가 되는 것.

반대로 가용성을 보장해야 한다고 하면 현자 정상 작동하고 있는 컴포넌트가
변경점을 계속 받아줘야 하는데 분단된 시스템은 이 변경점을 반영하지 못하게 되므로
분단된 시스템에 일관성을 보장하지 못하는 상태가 되는 것.

그래서 보통 가용성과 네트워크 파티션, 또는 일관성과 네트워크 파티션
이런 형태의 시스템으로 분산 시스템에서는 선택하게 된다.

분산 시스템에서 동작하면서 일관성이 엄밀히 요구된다면 CP 시스템을 선택해야 하고,
네트워크 파티션 같은 상황을 겪더라도 시스템이 잘 동작하길 기대한다면 AP 시스템을 선택해야 한다.

가끔 CAP 이론 이미지를 보면 AC 시스템으로 RDBMS 를 소개하기도 하는데,
여기서 말하는 RDBMS는 전통적인 역할로 인스턴스 하나에서 동작하는 시스템을 의미한다.
이런 시스템 같은 경우 네트워크가 분단되는 것과 같은 상황을 고려할 필요가 없는 것.

복제를 만들고 읽기 부하를 분산 시킨다든지, 이런 식으로 동작을 하면 바로 일관성이 훼손되게 된다.
CAP 이론이 그렇게까지 어려운 이론은 아니다.
또 한 가지 참고하자면 항상 CAP 이론에 입각해서 시스템이 설계되는 것도 아니다.

이론에 따르면 최대 2개의 속성을 선택할 수도 있지만
의도적으로 2개 이하를 선택하는 경우도. (ex. 현대 CPU 모델)
멀티 코어 형태의 CPU 캐시를 각자 가지고 있는 상태에서 
메모리에 값을 업데이트하고 그것과 동기화 하는 그 과정 마저 비동기로 동작하기 때문에
일관성이 완전히 보장되지는 않는다.

그러나 컴퓨터가 메모리 같은 것이 분단되어도 동작하기를 원하는 건 아니기에
네트워크 파티션 같은 분단 상태를 고려하지 않았음에도 불구하고 성능을 위해 일관성을 훼손한 것. 

CAP 이론이 굉장히 넓은 범위의 논리적인 이론이기에 이 이론이 틀릴 수는 없다.
굉장히 넓은 범위의 전제와 같은 의미이기 때문에 방금 예시가 CAP 이론이 틀렸다거나 무용지물이라는 건 아니지만
너무 당연하기 때문에 유용한 정리도 아니다. 

하지만 분산시스템의 컨셉을 이야기하기에 굉장히 좋은 이론.
특히 요즘 나오는 컴포넌트 중 `CAP를 모두 만족시키고 있다`라는 식의 홍보는 
최대한 노력을 했다 정도로 이해하는 게 논리적으로 맞는 말..